using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.EntityFrameworkCore;

using EduZasAPI.Domain.Common;
using EduZasAPI.Domain.Users;

using EduZasAPI.Application.Common;
using EduZasAPI.Application.Users;

using EduZasAPI.Infraestructure.EntityFramework.Application.Common;
using EduZasAPI.Infraestructure.EntityFramework.Application.Users;

namespace EduZasAPI.Test.Infraestructure.Application.Ports.DAOs;

/// <summary>
/// Contiene tests de integración para <see cref="UserEntityFrameworkRepository"/> 
/// que validan las operaciones CRUD y de búsqueda de usuarios en la base de datos.
/// </summary>
/// <remarks>
/// Esta clase de tests utiliza una base de datos real configurada para testing
/// y sigue el patrón Arrange-Act-Assert para estructuración clara de los tests.
/// </remarks>
public class UserEntityFrameworkRepositoryTest
{
    private IRepositoryAsync<ulong, UserDomain, NewUserDTO, UserUpdateDTO, UserCriteriaDTO> _repo;
    private EduZasDotnetContext _ctx;

    /// <summary>
    /// Inicializa una nueva instancia de la clase de tests configurando 
    /// el contenedor de dependencias y la conexión a la base de datos de testing.
    /// </summary>
    public UserEntityFrameworkRepositoryTest()
    {
        var config = new ConfigurationBuilder()
          .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
          .Build();

        var connStr = config.GetConnectionString("TestConnection");

        var s = new ServiceCollection();
        s.AddTransient<IRepositoryAsync<ulong, UserDomain, NewUserDTO, UserUpdateDTO, UserCriteriaDTO>>(prv =>
        {
            var ctx = prv.GetRequiredService<EduZasDotnetContext>();
            return new UserEntityFrameworkRepository(ctx, 10);
        });

        s.AddDbContext<EduZasDotnetContext>(opts =>
            opts.UseMySql(connStr, Microsoft.EntityFrameworkCore.ServerVersion.Parse("12.0.2-mariadb")));

        var sp = s.BuildServiceProvider();

        _repo = sp.GetRequiredService<IRepositoryAsync<ulong, UserDomain, NewUserDTO, UserUpdateDTO, UserCriteriaDTO>>();
        _ctx = sp.GetRequiredService<EduZasDotnetContext>();
    }

    /// <summary>
    /// Elimina y recrea la base de datos para asegurar un estado limpio antes de cada test.
    /// </summary>
    private async Task DeleteAndInitializeDatabaseAsync()
    {
        await _ctx.Database.EnsureDeletedAsync();
        await _ctx.Database.EnsureCreatedAsync();
    }

    /// <summary>
    /// Genera una dirección de email única para testing.
    /// </summary>
    /// <param name="hint">Texto opcional para incluir en el email.</param>
    /// <returns>Una dirección de email única en el dominio t.test.</returns>
    private static string CreateSafeEmail(string hint = "")
    {
        var id = (hint + Guid.NewGuid().ToString("N")).Replace("-", "");
        var local = "u" + id.Substring(0, Math.Min(8, id.Length)).ToLowerInvariant();
        return $"{local}@t.test";
    }

    /// <summary>
    /// Crea un DTO para nuevo usuario con valores por defecto opcionales.
    /// </summary>
    /// <param name="email">Email del usuario (opcional).</param>
    /// <param name="password">Contraseña del usuario (opcional).</param>
    /// <param name="firstName">Primer nombre del usuario (opcional).</param>
    /// <param name="fatherLastname">Apellido paterno del usuario (opcional).</param>
    /// <param name="midName">Segundo nombre del usuario (opcional).</param>
    /// <param name="motherLastname">Apellido materno del usuario (opcional).</param>
    /// <returns>Instancia de <see cref="NewUserDTO"/> configurada.</returns>
    private NewUserDTO CreateNew(
        string? email = null,
        string? password = null,
        string? firstName = null,
        string? fatherLastname = null,
        Optional<string>? midName = null,
        Optional<string>? motherLastname = null) => new NewUserDTO
        {
            Email = email ?? "test@test.com",
            Password = password ?? "test",
            FirstName = firstName ?? "Juan",
            FatherLastName = fatherLastname ?? "Lopez",
            MidName = midName ?? Optional<string>.Some("Carlos"),
            MotherLastname = motherLastname ?? Optional<string>.Some("Perez")
        };

    /// <summary>
    /// Crea un DTO de actualización a partir de un usuario de dominio existente.
    /// </summary>
    /// <param name="u">Usuario de dominio desde el cual copiar los datos.</param>
    /// <returns>Instancia de <see cref="UserUpdateDTO"/> con los datos del usuario.</returns>
    private UserUpdateDTO CreateUpdate(UserDomain u) => new UserUpdateDTO
    {
        Id = u.Id,
        Active = u.Active,
        Email = u.Email,
        Password = u.Password,
        FirstName = u.FirstName,
        FatherLastName = u.FatherLastName,
        MidName = u.MidName,
        MotherLastname = u.MotherLastname
    };

    /// <summary>
    /// Verifica que se pueda agregar un nuevo usuario correctamente.
    /// </summary>
    [Fact]
    public async Task Add_Success()
    {
        await DeleteAndInitializeDatabaseAsync();

        var dto = CreateNew();
        var record = await _repo.AddAsync(dto);

        Assert.NotNull(record);
        Assert.Equal(1ul, record.Id);
        Assert.Equal(dto.Email, record.Email);
        Assert.Equal(dto.FirstName, record.FirstName);
    }

    /// <summary>
    /// Verifica que no se puedan agregar usuarios con emails duplicados.
    /// </summary>
    [Fact]
    public async Task Add_RepeatedEmail()
    {
        await DeleteAndInitializeDatabaseAsync();

        var dto = CreateNew();
        var dto2 = CreateNew(
            firstName: "A",
            midName: "B".ToOptional(),
            fatherLastname: "C",
            motherLastname: "D".ToOptional(),
            password: "daljda");

        var record = await _repo.AddAsync(dto);

        try
        {
            var result = await _repo.AddAsync(dto);
            Assert.Fail("No deberia agregar un elemento");
        }
        catch (System.Exception)
        {
        }
    }

    /// <summary>
    /// Verifica que se pueda eliminar un usuario existente correctamente.
    /// </summary>
    [Fact]
    public async Task Delete_Success()
    {
        await DeleteAndInitializeDatabaseAsync();

        var dto = CreateNew();
        await _repo.AddAsync(dto);
        var record = await _repo.DeleteAsync(1);

        Assert.True(record.IsSome);
        Assert.Equal(1ul, record.Unwrap().Id);
        Assert.Equal(dto.Email, record.Unwrap().Email);
    }

    /// <summary>
    /// Verifica que se pueda obtener un usuario por su identificador.
    /// </summary>
    [Fact]
    public async Task Get_Success()
    {
        await DeleteAndInitializeDatabaseAsync();

        var dto = CreateNew();

        await _repo.AddAsync(dto);
        var record = await _repo.GetAsync(1);

        Assert.True(record.IsSome);
        Assert.Equal(1ul, record.Unwrap().Id);
        Assert.Equal(dto.Email, record.Unwrap().Email);
    }

    /// <summary>
    /// Verifica que se pueda actualizar correctamente la información de un usuario existente.
    /// </summary>
    [Fact]
    public async Task Update_success()
    {
        await DeleteAndInitializeDatabaseAsync();

        var user = await _repo.AddAsync(CreateNew());

        user.Active = false;
        user.MidName = "Alfredo".ToOptional();
        user.MotherLastname = "AQuitame".ToOptional();

        var updated = await _repo.UpdateAsync(CreateUpdate(user));

        Assert.NotNull(updated);
        Assert.True(updated.MidName.IsSome);
        Assert.True(updated.MotherLastname.IsSome);
        Assert.Equal("Alfredo", updated.MidName.UnwrapOr(""));
        Assert.Equal("AQuitame", updated.MotherLastname.UnwrapOr(""));
        Assert.False(updated.Active);
    }

    /// <summary>
    /// Inserta datos de prueba en la base de datos para tests de búsqueda.
    /// </summary>
    private async Task SeedUsersAsync()
    {
        var u1 = CreateNew(
            email: CreateSafeEmail("a1"),
            firstName: "ALICE",
            fatherLastname: "SMITH"
        );

        var u2 = CreateNew(
            email: CreateSafeEmail("a2"),
            firstName: "ALICIA",
            fatherLastname: "GOMEZ"
        );

        var u3 = CreateNew(
            email: CreateSafeEmail("a3"),
            firstName: "BOB",
            fatherLastname: "SMITH"
        );

        var u4 = CreateNew(
            email: CreateSafeEmail("a4"),
            firstName: "CHARLIE",
            fatherLastname: "JOHNSON"
        );

        var u1Created = await _repo.AddAsync(u1);
        await _repo.AddAsync(u2);
        await _repo.AddAsync(u3);
        await _repo.AddAsync(u4);

        u1Created.Active = false;
        await _repo.UpdateAsync(CreateUpdate(u1Created));
    }

    /// <summary>
    /// Proporciona casos de prueba para las búsquedas con diferentes criterios.
    /// </summary>
    /// <returns>Colección de objetos que representan los casos de prueba.</returns>
    public static IEnumerable<object?[]> SearchCases()
    {
        yield return new object?[]
        {
                new UserCriteriaDTO(), // todos None
                4,
        };

        // 2) Active = true => 3
        yield return new object?[]
        {
                new UserCriteriaDTO { Active = Optional<bool>.Some(true) },
                3,
        };

        // 3) FirstName EQ "ALICE" => 1
        yield return new object?[]
        {
                new UserCriteriaDTO
                {
                    FirstName = Optional<StringQueryDTO>.Some(new StringQueryDTO
                    {
                        SearchType = StringSearchType.EQ,
                        Text = "ALICE"
                    })
                },
                1,
        };

        // 4) FirstName LIKE "ALI" => 2 (ALICE + ALICIA)
        yield return new object?[]
        {
                new UserCriteriaDTO
                {
                    FirstName = Optional<StringQueryDTO>.Some(new StringQueryDTO
                    {
                        SearchType = StringSearchType.LIKE,
                        Text = "ALI"
                    })
                },
                2,
        };

        // 5) Active true + FirstName LIKE "ALI" => 1
        yield return new object?[]
        {
                new UserCriteriaDTO
                {
                    Active = Optional<bool>.Some(true),
                    FirstName = Optional<StringQueryDTO>.Some(new StringQueryDTO
                    {
                        SearchType = StringSearchType.LIKE,
                        Text = "ALI"
                    })
                },
                1,
        };

        // 6) Non-matching criteria => 0
        yield return new object?[]
        {
                new UserCriteriaDTO
                {
                    FirstName = Optional<StringQueryDTO>.Some(new StringQueryDTO
                    {
                        SearchType = StringSearchType.EQ,
                        Text = "NONEXISTENT"
                    })
                },
                0,
        };
    }

    /// <summary>
    /// Verifica que las búsquedas con diferentes criterios devuelvan el número esperado de resultados.
    /// </summary>
    /// <param name="criteria">Criterios de búsqueda a aplicar.</param>
    /// <param name="expectedCount">Número esperado de resultados.</param>
    [Theory]
    [MemberData(nameof(SearchCases))]
    public async Task Search_ByCriteria_ReturnsExpected(UserCriteriaDTO criteria, int expectedCount)
    {
        await DeleteAndInitializeDatabaseAsync();
        await SeedUsersAsync();

        var page = await _repo.GetByAsync(criteria);
        var actual = page.Results.Count;

        Assert.Equal(expectedCount, actual);
    }
}
